<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bodybuilding Training System</title>

<style>
  /* ---------- Theme Variables ---------- */
  :root{
    --bg: #0d0d0d;
    --card: #131313;
    --muted: #bdbdbd;
    --text: #fff;
    --accent: #ff2a2a;
    --accent-2: #ff6b6b;
    --border: rgba(255,255,255,0.06);
    --radius: 12px;
    --gap: 18px;
    --header-height: 72px; /* Define header height as a variable */
  }
  .light{
    --bg:#f7f7f7; --card:#fff; --muted:#333; --text:#111; --accent:#e60000; --border:rgba(0,0,0,0.08);
  }

  /* ---------- Base ---------- */
  *{box-sizing:border-box}
  /* FIX: Use min-height: 100vh for reliable full height on mobile browsers */
  html,body{height:100%;min-height:100vh;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Poppins',sans-serif;-webkit-font-smoothing:antialiased}
  a{color:inherit}
  /* Adjusted container margin/padding to account for fixed header */
  .container{
    width:94%;
    max-width:1200px;
    /* Use padding-top to create space for fixed header */
    padding: calc(var(--header-height) + var(--gap)) var(--gap) 60px;
    margin: 0 auto;
  }
  /* Ensure padding inside container is consistent */
  .container > div {
    padding: 0;
  }
  @media (max-width: 600px) {
    /* Slightly less vertical padding on small screens */
    .container {
        padding: calc(var(--header-height) + 12px) 12px 30px;
        width: 100%;
    }
  }


/* ---------- Header ---------- */
  header{
    position:fixed;left:0;right:0;top:0;height:var(--header-height);
    background:rgba(19, 19, 19, 0.9); /* More solid background for better readability */
    background:var(--card); /* Simplified background for better theme integration */
    display:flex;align-items:center;gap:16px;padding:12px 20px;border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
    z-index:1200; /* High z-index to prevent any overlap */
  }
  .light header{ background:rgba(255, 255, 255, 0.95); } /* Light theme background with transparency */
  header h1{margin:0;font-size:18px;letter-spacing:0.2px}
  .header-controls{margin-left:auto;display:flex;gap:10px;align-items:center}
  .plan-selector,.toggle-btn{appearance:none;border-radius:10px;padding:9px 12px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer; font-size:14px; }
  .toggle-btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;font-weight:700}
  @media (max-width: 500px) {
    header h1 { font-size: 16px; }
    .plan-selector, .toggle-btn { padding: 8px 10px; font-size: 13px; }
  }


/* ---------- Layout ---------- */
  .layout{display:grid;grid-template-columns:320px 1fr;gap:var(--gap)}
  @media (max-width:980px){
    /* Single column layout for tablets and phones */
    .layout{grid-template-columns:1fr;padding-top:0}
  }

  /* Sidebar styling adjustments */
  .sidebar{
    background:var(--card);padding:16px;border-radius:var(--radius);border:1px solid var(--border);
    min-height:220px;display:flex;flex-direction:column;gap:12px;
    /* Desktop: sticky position */
    position:sticky;
    top: calc(var(--header-height) + var(--gap) - 4px); /* Stick below the header */
  }
  @media (max-width:980px){
    /* Mobile/Tablet: remove sticky, allow flow */
    .sidebar{
        position: static;
    }
  }

  .panel{background:var(--card);padding:18px;border-radius:var(--radius);border:1px solid var(--border)}

/* ---------- Days Row ---------- */
  .days{display:flex;flex-wrap:wrap;gap:8px}
  .day{
    /* Use min/max to ensure it flexes but doesn't get too small or large */
    flex:1 1 auto;
    min-width: calc(100% / 4 - 6px); /* 4 per row on desktop/large tablet */
    max-width: 120px;
    background:transparent;border:1px solid var(--border);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all .18s;
    display: flex; /* Added flex for better content control */
    flex-direction: column; /* Stack day name and date */
    line-height: 1.2;
    font-size: 14px;
  }
  /* Added style for the date/small text inside the day button */
  .day .date-info {
    font-size: 11px;
    color: var(--muted);
    font-weight: 400;
    margin-top: 2px;
  }
  .day.active .date-info {
      color: rgba(255, 255, 255, 0.7);
  }

  @media (max-width: 500px) {
    /* 3 per row on small phones */
    .day {
      min-width: calc(100% / 3 - 6px);
      max-width: unset;
    }
  }
  .day:hover{transform:translateY(-3px)}
  .day.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border-color:transparent;box-shadow:0 6px 20px rgba(0,0,0,0.6)}

/* ---------- Exercises panel ---------- */
  .exercise-box{display:flex;flex-direction:column;gap:12px}
  /* Optimized grid for exercise rows */
  .exercise-row{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:12px}
  /* Original media query is a bit low, using the new auto-fit is better, but keep for fallback */
  @media (max-width:680px){.exercise-row{grid-template-columns:1fr}}

  .exercise-card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    padding:14px;border-radius:10px;border:1px solid var(--border);
    /* Reduced shadow for lighter look */
    box-shadow:0 4px 15px rgba(0,0,0,0.3);
    animation:floatIn .28s ease both;
  }
  .exercise-card h3{margin:0 0 8px 0;font-size:16px}
  .exercise-card p{margin:0;color:var(--muted);font-size:14px;line-height:1.6}

/* ---------- Custom Builder ---------- */
  .builder .input, input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);margin-top:10px}
  .add-btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer;margin-top:10px; transition: background-color 0.2s;}
  /* Ensure the custom list controls don't break layout */
  .custom-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .custom-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid var(--border);flex-wrap: wrap; gap: 8px;}
  .custom-item > div:first-child { flex: 1 1 50%; min-width: 150px; } /* Ensure text has space */
  .custom-item > div:last-child { display: flex; gap: 8px; }

  /* Adjust buttons inside custom-item */
  .custom-item .add-btn {
      width: auto;
      padding: 8px 10px !important;
      margin-top: 0 !important;
      font-size: 13px;
  }
  .custom-item .add-btn:first-of-type { /* Edit button style */
      background: var(--muted);
      color: var(--text);
  }
  .custom-item .add-btn:last-of-type { /* Delete button style */
      background: #8e1818; /* Darker red */
  }

/* ---------- Helpers ---------- */
  .muted{color:var(--muted)} .mb-8{margin-bottom:8px}
  @keyframes floatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}

/* ---------- Accessibility focus ---------- */
  .day:focus, .plan-selector:focus, .toggle-btn:focus, .add-btn:focus, .input:focus, .custom-item .add-btn:focus{outline:3px solid rgba(255,42,42,0.3);outline-offset:3px}
</style>
</head>
<body>

<header>
  <h1>Bodybuilding Training System</h1>
  <div class="header-controls">
    <label for="plan-select" class="small muted" style="display:none">Choose plan</label>
    <select id="plan-select" class="plan-selector" aria-label="Choose training plan"></select>
    <button id="theme-toggle" class="toggle-btn" onclick="toggleTheme()" aria-pressed="false">ðŸŒ— Mode</button>
  </div>
</header>

<main class="container">
  <div class="layout">

    <aside class="sidebar" aria-label="Week Planner">
      <div>
        <h2 style="margin:0 0 8px 0">Week Planner</h2>
        <p class="small muted mb-8">Tap a day to view exercises. Edit or add custom exercises below.</p>
      </div>

      <div class="days" id="day-tabs" role="tablist" aria-label="Days of week">
        <button class="day" data-day="1" role="tab">Day 1</button>
        <button class="day" data-day="2" role="tab">Day 2</button>
        <button class="day" data-day="3" role="tab">Day 3</button>
        <button class="day" data-day="4" role="tab">Day 4</button>
        <button class="day" data-day="5" role="tab">Day 5</button>
        <button class="day" data-day="6" role="tab">Day 6</button>
        <button class="day" data-day="7" role="tab">Day 7</button>
      </div>

      <div class="builder" aria-label="Custom builder">
        <h3 style="margin:8px 0 0 0">Custom Workout Builder</h3>
        <small class="small muted">Add an exercise for selected day.</small>

        <select id="custom-day" class="input" aria-label="Choose day for custom exercise"></select>
        <input id="custom-exercise" class="input" placeholder="Enter Exercise (e.g. Cable Fly â€” 4Ã—12)" aria-label="Exercise description" />
        <button class="add-btn" onclick="addCustomExercise()">Add Exercise</button>

        <div id="custom-list" class="custom-list" aria-live="polite"></div>
      </div>
    </aside>

    <section class="panel">
      <div id="exercise-container" class="exercise-box" aria-live="polite">
        <h2 style="margin:0 0 8px 0">Select a day</h2>
        <p class="muted small">Choose a day from the left to view the workout. Use the plan selector at top to change programs.</p>
      </div>
      
      <div class="footer">Tip: Your custom changes are saved to your browser. Use the theme button to toggle light/dark.</div>

    </section>

  </div>
</main>

<script>
/* ---------------- DEFAULT PLANS (Option B â€” Medium selections) ---------------- */
const defaultPlans = {
  "Chest Priority": {
    1:{title:"Chest â€” Heavy & Volume", exercises:[
      "Barbell Bench Press â€” 5Ã—5",
      "Incline Dumbbell Press â€” 4Ã—8â€“10",
      "Flat Dumbbell Press â€” 4Ã—10",
      "Cable Fly (Low to High) â€” 4Ã—12",
      "Chest Dips (weighted if possible) â€” 3Ã—AMRAP",
      "Dumbbell Pullover â€” 3Ã—12"
    ]},
    2:{title:"Back â€” Width & Thickness", exercises:[
      "Deadlift â€” 4Ã—4â€“6",
      "Weighted Pull-ups â€” 4Ã—6â€“10",
      "Bent-Over Barbell Row â€” 4Ã—6â€“8",
      "Seated Cable Row â€” 4Ã—10",
      "Lat Pulldown (wide grip) â€” 3Ã—10â€“12"
    ]},
    3:{title:"Shoulders & Traps", exercises:[
      "Overhead Barbell Press â€” 4Ã—6â€“8",
      "Dumbbell Lateral Raise â€” 4Ã—12â€“15",
      "Rear Delt Fly / Face Pulls â€” 4Ã—12",
      "Barbell Shrugs â€” 4Ã—10",
      "Arnold Press â€” 3Ã—10"
    ]},
    4:{title:"Legs â€” Quad Focus", exercises:[
      "Back Squat â€” 5Ã—5",
      "Leg Press â€” 4Ã—10",
      "Walking Lunges â€” 3Ã—12 each leg",
      "Leg Extension â€” 4Ã—12",
      "Standing Calf Raises â€” 4Ã—15â€“20"
    ]},
    5:{title:"Chest â€” Pump & Volume", exercises:[
      "Incline Bench â€” 4Ã—8â€“10",
      "Decline Dumbbell Press â€” 4Ã—10",
      "Cable Crossover â€” 4Ã—15",
      "Pec Deck / Machine Fly â€” 3Ã—12",
      "Push-Ups (slow tempo) â€” 3Ã—AMRAP"
    ]},
    6:{title:"Arms â€” Biceps & Triceps", exercises:[
      "Barbell Curl â€” 4Ã—8â€“10",
      "Hammer Curl â€” 4Ã—10â€“12",
      "Preacher Curl â€” 3Ã—10",
      "Skull Crushers â€” 4Ã—8â€“10",
      "Triceps Rope Pushdown â€” 4Ã—12",
      "Reverse Wrist Curl â€” 3Ã—15"
    ]},
    7:{title:"Rest & Mobility", exercises:[
      "Light Stretching â€” 15â€“20 min",
      "Foam Rolling â€” 10 min",
      "Optional Light Walk â€” 20â€“30 min"
    ]}
  },

  "Gymrat PPL": {
    1:{title:"Push â€” Chest/Shoulders/Triceps", exercises:[
      "Barbell Bench Press â€” 5Ã—5",
      "Overhead Press â€” 4Ã—6â€“8",
      "Incline Dumbbell Press â€” 4Ã—8â€“10",
      "Lateral Raises â€” 4Ã—12",
      "Triceps Dips â€” 3Ã—AMRAP"
    ]},
    2:{title:"Pull â€” Back/Biceps", exercises:[
      "Deadlift â€” 4Ã—4â€“6",
      "Pull Ups â€” 4Ã—6â€“10",
      "One-Arm Dumbbell Row â€” 4Ã—8â€“10",
      "Face Pulls â€” 4Ã—12",
      "EZ Bar Curl â€” 3Ã—10"
    ]},
    3:{title:"Legs â€” Full", exercises:[
      "Squat â€” 5Ã—5",
      "Romanian Deadlift â€” 4Ã—8",
      "Leg Press â€” 4Ã—10",
      "Hamstring Curl â€” 4Ã—12",
      "Seated Calf Raise â€” 4Ã—15"
    ]},
    4:{title:"Push â€” Volume", exercises:[
      "Incline Bench â€” 4Ã—10",
      "Dumbbell Shoulder Press â€” 4Ã—10",
      "Chest Fly â€” 4Ã—12",
      "Triceps Pushdown â€” 4Ã—12"
    ]},
    5:{title:"Pull â€” Volume", exercises:[
      "Lat Pulldown â€” 4Ã—12",
      "Cable Row â€” 4Ã—12",
      "Hammer Curl â€” 4Ã—12",
      "Rear Delt Raises â€” 3Ã—15"
    ]},
    6:{title:"Legs â€” Hypertrophy", exercises:[
      "Front Squat â€” 4Ã—8",
      "Bulgarian Split Squat â€” 3Ã—10",
      "Glute Bridge â€” 4Ã—12",
      "Calf Raise â€” 4Ã—20"
    ]},
    7:{title:"Rest", exercises:[
      "Mobility Work â€” 15 min",
      "Optional Swim/Walk â€” 20â€“30 min"
    ]}
  },

  "Fat-Loss Hybrid": {
    1:{title:"Chest + HIIT", exercises:[
      "Incline DB Press â€” 4Ã—12",
      "Push-ups â€” 3Ã—15â€“20",
      "Cable Fly â€” 3Ã—15",
      "HIIT Sprints â€” 12â€“15 min"
    ]},
    2:{title:"Back + Core", exercises:[
      "Pull Ups â€” 4Ã—8â€“10",
      "Seated Row â€” 4Ã—12",
      "Plank â€” 3Ã—60s",
      "Mountain Climbers â€” 3Ã—30s"
    ]},
    3:{title:"Legs + Cardio", exercises:[
      "Squat â€” 4Ã—10",
      "Walking Lunges â€” 3Ã—12",
      "Kettlebell Swing â€” 4Ã—12",
      "Bike â€” 20 min steady"
    ]},
    4:{title:"Shoulders & Arms", exercises:[
      "Overhead Press â€” 4Ã—8",
      "Side Lateral â€” 4Ã—12",
      "Bicep Curl â€” 4Ã—10",
      "Triceps Rope â€” 4Ã—12"
    ]},
    5:{title:"Full Body Metcon", exercises:[
      "Thrusters â€” 4Ã—10",
      "Burpees â€” 3Ã—15",
      "Row â€” 500m x3 (rest between sets)",
      "Core Circuit â€” 10 min"
    ]},
    6:{title:"Active Recovery", exercises:[
      "Yoga Flow â€” 20 min",
      "Light Cardio â€” 20 min"
    ]},
    7:{title:"Rest", exercises:[
      "Stretching â€” 15 min"
    ]}
  },

  "Aesthetic Split": {
    1:{title:"Chest & Shoulders", exercises:[
      "Flat Bench â€” 4Ã—8",
      "Incline Fly â€” 4Ã—12",
      "Lateral Raise â€” 4Ã—15",
      "Cable Fly â€” 3Ã—15"
    ]},
    2:{title:"Back & Arms", exercises:[
      "Deadlift â€” 4Ã—6",
      "Pull Ups â€” 4Ã—8",
      "Barbell Row â€” 4Ã—8",
      "EZ Bar Curl â€” 4Ã—10"
    ]},
    3:{title:"Legs", exercises:[
      "Squat â€” 4Ã—8",
      "Leg Press â€” 4Ã—10",
      "Hamstring Curl â€” 4Ã—12",
      "Standing Calf â€” 4Ã—15"
    ]},
    4:{title:"Chest Pump", exercises:[
      "Incline DB Press â€” 4Ã—10",
      "Cable Crossover â€” 4Ã—15",
      "Push-Ups â€” 3Ã—AMRAP"
    ]},
    5:{title:"Shoulders & Arms", exercises:[
      "OHP â€” 4Ã—8",
      "Hammer Curl â€” 4Ã—12",
      "Skull Crushers â€” 4Ã—10"
    ]},
    6:{title:"Full Body Pump", exercises:[
      "Bench â€” 3Ã—10",
      "Row â€” 3Ã—12",
      "Squat â€” 3Ã—12",
      "Core Work â€” 8â€“10 min"
    ]},
    7:{title:"Rest", exercises:[
      "Mobility â€” 15 min"
    ]}
  }
};

/* ---------------- DATE AND DAY UTILITIES (UPDATED) ---------------- */
const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

/**
 * Calculates the next 7 days and maps them to workout IDs (1-7),
 * ensuring the calculated Sunday always maps to the Rest Day (Workout ID 7).
 * The other 6 workout IDs (1-6) are rotated to fill the remaining 6 days of the week.
 */
function getWeekInfo() {
  const week = [];
  const today = new Date();
  
  // 0=Sun, 1=Mon, ..., 6=Sat
  const currentDayOfWeek = today.getDay(); 
  
  // Calculate which workout ID should be applied to today's date (Day 0 in the loop).
  // We need to find the day offset from Sunday (Day 7/Rest).
  // Since 0=Sun maps to 7, 1=Mon maps to 1, ..., 6=Sat maps to 6 (if we ignore the forced rotation).
  // Day 7 is always Sunday's workout data.
  
  // Create an array of workout IDs in order, excluding 7 (Rest Day).
  const workoutIdRotation = [1, 2, 3, 4, 5, 6]; 
  
  // Get the day index for the start of the rotation (Monday=1).
  // If today is Monday (1), it should start with Workout ID 1.
  // If today is Tuesday (2), it should start with Workout ID 2.
  // The workout ID applied to the current day (i=0) should be based on where we are in the 6-day cycle.
  
  // Find the index in the rotation array corresponding to the current day (Mon-Sat).
  // JavaScript day 1 (Mon) should use rotation index 0 (Workout ID 1).
  // JavaScript day 0 (Sun) is handled separately (always Workout ID 7).
  let startRotationIndex = (currentDayOfWeek === 0) ? 0 : currentDayOfWeek - 1; // 0 for Mon, 1 for Tue, etc. (Max 5 for Sat)
  
  // If today is Sunday (0), the rotation starts from Monday's workout (ID 1) the next day.
  if (currentDayOfWeek === 0) {
      startRotationIndex = 0; // Monday's workout ID (1) will be used for the next day (Monday)
  }
  
  for (let i = 0; i < 7; i++) {
    const day = new Date(today);
    day.setDate(today.getDate() + i);
    
    // Day of week for the current iterated date (0=Sun, 1=Mon, ...)
    const iteratedDayOfWeek = day.getDay();
    
    // Day number (1-7) corresponding to the display index
    const displayDayNumber = (i + 1);
    
    // Day name (Today, Mon, Tue, etc.)
    const dayName = i === 0 ? 'Today' : dayNames[iteratedDayOfWeek];
    
    // Date in DD/MM format
    const date = day.getDate();
    
    let workoutId;
    
    if (iteratedDayOfWeek === 0) {
        // If the iterated day is Sunday, always use the plan's Day 7 data (Rest Day).
        workoutId = 7; 
    } else {
        // For Mon-Sat, use the rotating plan IDs (1-6).
        // Calculate the index in the 6-day rotation (1, 2, 3, 4, 5, 6) based on the current day's offset from today.
        
        // This calculates which of the 6 workout IDs (1-6) should be applied to the current day.
        // If today is Monday and i=0, (1-1 + 0) % 6 = 0, Workout ID = 1
        // If today is Saturday and i=0, (6-1 + 0) % 6 = 5, Workout ID = 6
        // If today is Monday and i=6 (next Sunday), it skips here and uses ID 7.
        
        // Find the "workout day" number (1-6) that this actual day should run.
        let workoutDayOffset = iteratedDayOfWeek - 1; // 0 for Mon, 1 for Tue, ..., 5 for Sat
        
        // Find the starting offset in the workoutIdRotation array
        // (Current actual day of week - 1) gives 0-5 for Mon-Sat.
        // The rotation is Monday = W1, Tuesday = W2, etc.
        
        // If today is Mon (1), i=0: (1-1) % 6 = 0. Use WID 1.
        // If today is Tue (2), i=0: (2-1) % 6 = 1. Use WID 2.
        
        // If today is Sat (6), i=0: (6-1) % 6 = 5. Use WID 6.
        // If today is Sat (6), i=1 (Sun): Uses WID 7.
        // If today is Sat (6), i=2 (Next Mon): (1-1 + 2) % 6 = 2. Use WID 3 (W1, W2, W3, W4, W5, W6, W7, W1, W2) WRONG.

        // Simpler way: Calculate the difference between the target day's actual day-of-week 
        // and the starting day's actual day-of-week, modulo 6, then add the starting workout ID.
        
        // Step 1: Find the Workout ID for Today (i=0)
        let startingWorkoutId = (currentDayOfWeek === 0) ? 1 : currentDayOfWeek; // 1 for Mon, 6 for Sat. If Sun (0), start with 1.
        
        // If the current day is Sunday (iteratedDayOfWeek === 0), it's handled above (workoutId = 7).
        
        // Find the index in the 1-6 cycle relative to the start of the 1-6 cycle.
        // Workout IDs 1-6 map to Mon-Sat.
        let workoutDayIndex = iteratedDayOfWeek - 1; // 0 for Mon, 1 for Tue, ..., 5 for Sat
        
        // Now find the ID in the plan (1-6) that should map to this day.
        // Start by finding the ID that corresponds to the initial day (i=0)
        let currentWorkoutIdIndex = (currentDayOfWeek === 0) ? 0 : currentDayOfWeek - 1; // 0 for Mon, 5 for Sat
        
        // Calculate how many days passed since Today (i)
        let totalOffset = i;
        
        // Account for Sunday skips in the rotation (if Sunday is today, we skip the rest day in the rotation).
        let sundaySkips = 0;
        for (let j = 0; j < i; j++) {
            const tempDay = new Date(today);
            tempDay.setDate(today.getDate() + j);
            if (tempDay.getDay() === 0) { // If any of the previous days were Sunday
                sundaySkips++;
            }
        }
        
        // Simplified: The workout IDs 1-6 must be assigned to the next 6 non-Sunday days in sequence.
        
        let nonSundayCount = 0;
        let finalWorkoutId = -1;
        for (let j = 0; j <= i; j++) {
            const tempDay = new Date(today);
            tempDay.setDate(today.getDate() + j);
            if (tempDay.getDay() !== 0) { // If it's Mon-Sat
                nonSundayCount++;
                finalWorkoutId = (nonSundayCount % 6 === 0) ? 6 : nonSundayCount % 6;
            }
        }
        
        workoutId = finalWorkoutId;
    }
    
    // Store the mapping: display day number (1-7) maps to workoutId (1-7)
    week.push({ 
        displayDayNumber: displayDayNumber, 
        dayName: dayName, 
        date: date, 
        workoutId: workoutId // This is the ID (1-7) from the defaultPlans/workouts to use
    });
  }
  return week;
}


// Recalculate and store the correct mapping
const weekInfo = getWeekInfo(); 
let currentDayIndex = 1; 

/* ---------------- LOAD / INIT ---------------- */
let currentPlanName = localStorage.getItem("planName") || "Chest Priority";
let workouts = JSON.parse(localStorage.getItem("workouts")) || JSON.parse(JSON.stringify(defaultPlans[currentPlanName]));

/* ---------- Populate plan select ---------- */
const planSelect = document.getElementById('plan-select');
Object.keys(defaultPlans).forEach(name=>{
  const opt = document.createElement('option');
  opt.value = name; opt.textContent = name;
  planSelect.appendChild(opt);
});
planSelect.value = currentPlanName;
planSelect.addEventListener('change', () => {
  currentPlanName = planSelect.value;
  // Deep clone default plan to 'workouts' when a new one is selected
  workouts = JSON.parse(JSON.stringify(defaultPlans[currentPlanName])); 
  saveWorkouts();
  // Select day 1 after changing plan
  showExercises(1); 
});

/* ---------- Populate custom day select ---------- */
const customDaySelect = document.getElementById('custom-day');
customDaySelect.innerHTML = ''; // Clear existing options
weekInfo.forEach(info => {
    const o = document.createElement('option'); 
    // Use the display day number (1-7) for the value, but the Workout ID for the lookup later.
    // We must use the displayDayNumber (1-7) for the value since the custom list relies on this index.
    o.value = info.displayDayNumber; 
    o.textContent = `${info.dayName} (${info.date})`; 
    customDaySelect.appendChild(o); 
});

/* ---------- Day buttons (UPDATED) ---------- */
const dayTabs = document.getElementById('day-tabs');
dayTabs.innerHTML = ''; // Clear default HTML buttons

weekInfo.forEach(info => {
    const btn = document.createElement('button');
    btn.className = 'day';
    // Use the displayDayNumber (1-7) for the data-day attribute for clicking/indexing
    btn.dataset.day = info.displayDayNumber; 
    btn.role = 'tab';
    btn.innerHTML = `<strong>${info.dayName}</strong><span class="date-info">${info.date}</span>`;
    dayTabs.appendChild(btn);
});

dayTabs.addEventListener('click', (e)=>{
  const btn = e.target.closest('.day');
  if(btn){
    const d = btn.dataset.day;
    document.getElementById('custom-day').value = d;
    showExercises(d);
  }
});

/* ---------- Show exercises ---------- */
function showExercises(dayDisplayIndex){
  currentDayIndex = dayDisplayIndex; // Update the global tracker
  
  // Find the corresponding weekInfo entry to get the correct workoutId
  const dayInfo = weekInfo.find(d => d.displayDayNumber == dayDisplayIndex);
  if (!dayInfo) return;
  
  const dayWorkoutId = dayInfo.workoutId; // This is the ID (1-7) of the plan data to use
  
  // active style
  document.querySelectorAll('.day').forEach(x=>x.classList.remove('active'));
  const clicked = document.querySelector(`.day[data-day="${dayDisplayIndex}"]`);
  if(clicked){ 
    clicked.classList.add('active'); 
    clicked.focus(); 
  }

  // --- Core change: Use dayWorkoutId to look up the workout data ---
  const data = workouts[dayWorkoutId];
  const box = document.getElementById('exercise-container');
  if(!data){ box.innerHTML = '<h2>Workout data not found for this day</h2>'; return; }

  // Build layout: heading + exercise cards
  let html = `<h2 style="margin:0 0 10px 0">${data.title}</h2>`;
  html += `<div class="exercise-row">`;

  // Filter out custom exercises which will be loaded in the sidebar list
  // NOTE: This comparison must use the Day's original Workout ID (dayWorkoutId)
  const defaultEx = data.exercises.filter(ex => {
      const currentPlanDefault = defaultPlans[currentPlanName][dayWorkoutId];
      return currentPlanDefault && currentPlanDefault.exercises.includes(ex);
  });
  
  const primaryList = defaultEx.length > 0 ? defaultEx : data.exercises;
  
  // split exercises into two columns evenly
  const perCol = Math.ceil(primaryList.length / 2);
  const col1 = primaryList.slice(0, perCol);
  const col2 = primaryList.slice(perCol);

  html += `<div class="exercise-card"><h3>Primary Focus</h3><p>${col1.map(e=>'â€¢ '+escapeHtml(e)).join('<br>')}</p></div>`;
  
  const secondaryContent = col2.length ? 
      col2.map(e=>'â€¢ '+escapeHtml(e)).join('<br>') : 
      (col1.length > 0 ? 'â€¢ Accessory work / Finisher' : 'â€¢ Active Rest / Mobility');
      
  html += `<div class="exercise-card"><h3>Secondary / Accessories</h3><p>${secondaryContent}</p></div>`;

  html += `</div>`; // exercise-row

  box.innerHTML = html;
  // --- Core change: loadCustomList must use the dayDisplayIndex (1-7) to look up the local data ---
  loadCustomList(dayDisplayIndex);
}

/* ---------- Custom builder functions ---------- */
function loadCustomList(dayDisplayIndex){
  const list = document.getElementById('custom-list');
  list.innerHTML = '';
  
  // Find the corresponding weekInfo entry
  const dayInfo = weekInfo.find(d => d.displayDayNumber == dayDisplayIndex);
  if (!dayInfo) return;

  const dayWorkoutId = dayInfo.workoutId;

  // Retrieve the original/default exercises for the matched workout plan day
  const defaultExercises = defaultPlans[currentPlanName][dayWorkoutId].exercises;
  
  // The workouts array stores data using the plan's Day ID (1-7).
  const currentDayWorkouts = workouts[dayWorkoutId].exercises || [];
  
  // Find custom exercises by comparing to the default plan for that dayWorkoutId
  const customExercises = currentDayWorkouts.filter(ex => !defaultExercises.includes(ex));
  
  if (customExercises.length === 0) {
      list.innerHTML = `<p class="small muted" style="margin-top:10px">No custom exercises for this day.</p>`;
      // Ensure custom-day select is still set to the currently viewed day
      document.getElementById('custom-day').value = dayDisplayIndex; 
      return;
  }
  
  customExercises.forEach((ex,i)=>{
    // Find the original index in the main 'workouts' array (using dayWorkoutId)
    const originalIndex = currentDayWorkouts.indexOf(ex); 
      
    const wrapper = document.createElement('div'); wrapper.className='custom-item';
    const left = document.createElement('div');
    left.innerHTML = `<strong style="display:block">${ex}</strong><span class="small muted">${dayInfo.dayName} (${dayInfo.date}) â€¢ Custom #${i+1}</span>`;
    const actions = document.createElement('div');
    
    // Pass dayWorkoutId to edit/delete functions so they modify the correct workout data (1-7)
    const editBtn = document.createElement('button'); 
    editBtn.textContent='Edit'; 
    editBtn.className='add-btn'; 
    editBtn.onclick = ()=> editExercise(dayWorkoutId, originalIndex, dayDisplayIndex);
    
    const delBtn = document.createElement('button'); 
    delBtn.textContent='Delete'; 
    delBtn.className='add-btn'; 
    delBtn.onclick = ()=> deleteExercise(dayWorkoutId, originalIndex, dayDisplayIndex);
    
    actions.appendChild(editBtn); actions.appendChild(delBtn);
    wrapper.appendChild(left); wrapper.appendChild(actions);
    list.appendChild(wrapper);
  });
  // Ensure custom-day select is set to the currently viewed day
  document.getElementById('custom-day').value = dayDisplayIndex;
}


function addCustomExercise(){
  const dayDisplayIndex = document.getElementById('custom-day').value;
  const ex = document.getElementById('custom-exercise').value.trim();
  if(!ex){ alert('Enter a valid exercise'); return; }
  
  // Find the correct Workout ID (1-7) that corresponds to this display day
  const dayInfo = weekInfo.find(d => d.displayDayNumber == dayDisplayIndex);
  if (!dayInfo) return;
  const dayWorkoutId = dayInfo.workoutId;
  
  // Add new custom exercise to the end of the correct day's exercise list
  workouts[dayWorkoutId].exercises.push(ex);
  saveWorkouts();
  document.getElementById('custom-exercise').value = '';
  showExercises(dayDisplayIndex);
}

// Added dayDisplayIndex to refresh the view correctly
function editExercise(dayWorkoutId, index, dayDisplayIndex){
  const current = workouts[dayWorkoutId].exercises[index];
  const v = prompt('Edit exercise:', current);
  if(v && v.trim()!==''){ 
      workouts[dayWorkoutId].exercises[index] = v.trim(); 
      saveWorkouts(); 
      showExercises(dayDisplayIndex); 
  }
}
// Added dayDisplayIndex to refresh the view correctly
function deleteExercise(dayWorkoutId, index, dayDisplayIndex){
  const isDefault = defaultPlans[currentPlanName][dayWorkoutId].exercises.includes(workouts[dayWorkoutId].exercises[index]);
  
  let msg = 'Remove this exercise?';
  if(isDefault) {
      msg = 'This is a default exercise. Do you want to remove it from this day? (You can re-add it by switching plans and back.)';
  }
  
  if(confirm(msg)){ 
      workouts[dayWorkoutId].exercises.splice(index,1); 
      saveWorkouts(); 
      showExercises(dayDisplayIndex); 
  }
}

/* ---------- Save / storage ---------- */
function saveWorkouts(){ localStorage.setItem('workouts', JSON.stringify(workouts)); localStorage.setItem('planName', currentPlanName); }

/* ---------- Auto-select today (UPDATED) ---------- */
// Today corresponds to the display Day 1
showExercises(1);

/* ---------- Theme ---------- */
const themeToggle = document.getElementById('theme-toggle');
if(localStorage.getItem('theme')==='light'){
    document.body.classList.add('light');
    themeToggle.setAttribute('aria-pressed', 'true');
} else {
    themeToggle.setAttribute('aria-pressed', 'false');
}

function toggleTheme(){
  document.body.classList.toggle('light');
  const isLight = document.body.classList.contains('light');
  themeToggle.setAttribute('aria-pressed', isLight? 'true' : 'false');
  localStorage.setItem('theme', isLight? 'light':'dark');
}

/* ---------- Utility ---------- */
function escapeHtml(text){
  return String(text).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}
</script>

</body>
</html>
